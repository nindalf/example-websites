<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width" /><meta charSet="utf-8" /><link rel="icon" href="/favicon.ico" /><title>Implementing AES</title><meta name="charset" content="utf-8" /><meta name="author" content="Krishna Sundarram" /><meta name="description" content="Krishna&#x27;s personal blog" /><link href="https://blog.nindalf.com/index.xml" rel="alternate" type="application/rss+xml" title="Krishna&#x27;s personal blog" /><meta name="next-head-count" content="8" /><link rel="preload" href="/_next/static/css/37c6e985df8853b529b3.css" as="style" /><link rel="stylesheet" href="/_next/static/css/37c6e985df8853b529b3.css" data-n-g="" /><link rel="preload" href="/_next/static/css/740b20632ac80250c7f0.css" as="style" /><link rel="stylesheet" href="/_next/static/css/740b20632ac80250c7f0.css" data-n-p="" /><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-18c200bfa4628d9da94c.js" as="script" /><link rel="preload" href="/_next/static/chunks/framework-5e33f488d9410ce9ba9d.js" as="script" /><link rel="preload" href="/_next/static/chunks/597-e9cbf8ad4e8557f256b3.js" as="script" /><link rel="preload" href="/_next/static/chunks/778-c9e86f308cd9cb372f22.js" as="script" /><link rel="preload" href="/_next/static/chunks/main-9ca82ec4d4aca520c43d.js" as="script" /><link rel="preload" href="/_next/static/chunks/pages/_app-33eebf5131cfd5d17810.js" as="script" /><link rel="preload" href="/_next/static/chunks/941-89b1c2f25315e4a44edb.js" as="script" /><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bid%5D-4aeed08a217f27d1079a.js" as="script" /></head><body><div id="__next"><div><header class="utils_header__1rqd-"><ul class="utils_headingLg__de7p0"><li class="utils_headingLg__de7p0"><a href="/about/">About</a></li><li class="utils_headingLg__de7p0"><a href="/">Home</a></li></ul></header><main><article><h1>Implementing AES</h1><div class="utils_lightText__12Ckm"><time dateTime="2015-07-30">July 30, 2015</time> <div>8<!-- --> min read</div></div><div><p>The Advanced Encryption Standard is the most widely used encryption algorithm today. Its fast and secure but also easy to understand and implement.</p>
<p>If you're interested in learning about AES, look at this comic - <a href="http://www.moserware.com/2009/09/stick-figure-guide-to-advanced.html">A Stick Figure Guide to the Advanced Encryption Standard</a>. He splits his comic into 4 Acts:</p>
<ol>
<li>brief history of crypto</li>
<li>crypto basics</li>
<li>implementation</li>
<li>math.</li>
</ol>
<p>He did a great job with all 4 parts, but I thought elaborating on the implementation would be helpful. In this post, I will only assume you've read Acts 2 and 3 and signed the foot-shooting-prevention agreement.</p>
<center>![Agreement](https://i.imgur.com/bPZzTwsl.png)</center>
<hr>
<h3>AES Encryption</h3>
<p>The implementation of AES involves doing a set of simple operations repeatedly. Each repetition is called a "round". Depending on the size of the key (128, 192 or 256 bit), the input (block of 16 bytes) goes through 10, 12 or 14 rounds. In applying the 2 Big Ideas - Diffusion and Confusion, AES makes sure that each bit in the 16 byte block depends on every bit in the same block from 2 rounds previously. That's quite the achievement, so lets speak about the operations in detail.</p>
<p>Each round consists of 4 steps</p>
<ol>
<li>applying a key - <code>addRoundKey()</code></li>
<li>substituting bytes - <code>subBytes()</code></li>
<li>shifting rows - <code>shiftRows()</code></li>
<li>mixing columns - <code>mixColumns()</code></li>
</ol>
<p>Decryption involves the inverse of these steps, in reverse order</p>
<ol>
<li>inverse-mixing columns - <code>invMixColumns()</code></li>
<li>inverse-shifting rows - <code>invShiftRows()</code></li>
<li>inverse-substituting bytes - <code>invSubBytes()</code></li>
<li>applying a key - <code>addRoundKey()</code></li>
</ol>
<p>Have a look at the <code>encrypt</code> function below, implemented in Go (Go has a C-like syntax)</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> expkey <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> rounds <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	keyi <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token function">addRoundKey</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> expkey<span class="token punctuation">[</span>keyi<span class="token punctuation">:</span>keyi<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	keyi <span class="token operator">+=</span> <span class="token number">4</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> rounds<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">subBytes</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
		<span class="token function">shiftRows</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
		<span class="token function">mixColumns</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
		<span class="token function">addRoundKey</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> expkey<span class="token punctuation">[</span>keyi<span class="token punctuation">:</span>keyi<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		keyi <span class="token operator">+=</span> <span class="token number">4</span>
	<span class="token punctuation">}</span>
	<span class="token function">subBytes</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
	<span class="token function">shiftRows</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
	<span class="token function">addRoundKey</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> expkey<span class="token punctuation">[</span>keyi<span class="token punctuation">:</span>keyi<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Notes on the implementation:</p>
<ul>
<li>The 16-byte block, called state is represented as a slice of 4 4-byte unsigned integers. The 4-byte unsigned int is also referred to as a "word".</li>
<li>The expanded key is based on the original key. Its 16*(rounds+1) bytes in length.</li>
</ul>
<hr>
<h3>Step 1: subBytes and invSubBytes</h3>
<p>All the 4 operations are invertible. If you took any random 16-byte state and applied any operation and its inverse, you'd get back the original state. This is how decryption is a simple mirror of the encryption process.</p>
<p>In <code>subBytes</code> each of the 16 bytes is replaced by a byte from the S-box (a lookup table). The code would look like:</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">input<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> sbox<span class="token punctuation">[</span>input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">// i = 0, 1, ..., 15</span>
</code></pre></div>
<p>For <code>invSubBytes</code>, only the lookup table is changed. The code is <code>input[i] = invsbox[input[i]]</code>. The values for both lookup tables can be found on the <a href="https://en.wikipedia.org/wiki/Rijndael_S-box">wiki page</a>. If this step appears really simple, its because it is. Nevertheless, I'd suggest writing a test to check if its working correctly.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">input <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">{</span><span class="token number">0x8e9ff1c6</span><span class="token punctuation">,</span> <span class="token number">0x4ddce1c7</span><span class="token punctuation">,</span> <span class="token number">0xa158d1c8</span><span class="token punctuation">,</span> <span class="token number">0xbc9dc1c9</span><span class="token punctuation">}</span>
expected <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">{</span><span class="token number">0x19dba1b4</span><span class="token punctuation">,</span> <span class="token number">0xe386f8c6</span><span class="token punctuation">,</span> <span class="token number">0x326a3ee8</span><span class="token punctuation">,</span> <span class="token number">0x655e78dd</span><span class="token punctuation">}</span>
</code></pre></div>
<p>Another useful test would be to apply <code>subBytes</code> and <code>invSubBytes</code> on 16 random bytes and check if you get back the original.</p>
<hr>
<h3>Step 2: shiftRows and invShiftRows</h3>
<p>In <code>shiftRows</code>, the rows are shifted left. The top row is left untouched, the second row by 1 byte, the third row by 2 bytes, the fourth row by 3 bytes. As depicted below</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/6/66/AES-ShiftRows.svg" alt="shiftrows"></p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">shiftRows</span><span class="token punctuation">(</span>state <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">// rotate word left by specified number of bytes</span>
		state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rotWordLeft</span><span class="token punctuation">(</span>state<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>To test if <code>shiftRows</code> working correctly, use this input</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">input <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">{</span>
		<span class="token number">0x8e9f01c6</span><span class="token punctuation">,</span>
		<span class="token number">0x4ddc01c6</span><span class="token punctuation">,</span>
		<span class="token number">0xa15801c6</span><span class="token punctuation">,</span>
		<span class="token number">0xbc9d01c6</span><span class="token punctuation">}</span>
expected <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">{</span>
		<span class="token number">0x8e9f01c6</span><span class="token punctuation">,</span>
		<span class="token number">0xdc01c64d</span><span class="token punctuation">,</span>
		<span class="token number">0x01c6a158</span><span class="token punctuation">,</span>
		<span class="token number">0xc6bc9d01</span><span class="token punctuation">}</span>
</code></pre></div>
<p><code>invShiftRows</code> is the inverse operation. The top row is left untouched and the next 3 rows are shifted right by 1, 2, 3 bytes. Again, I'd recommend writing a test to ensure that applying both <code>shiftRows</code> and <code>invShiftRows</code> to random bytes returns the original.</p>
<hr>
<h3>Step 3: mixColumns and invMixColumns</h3>
<p>This step is slightly complicated, compared to the other 3. The state is operated on column-wise. Each byte of the column is replaced based on an operation. As you'd expect, in <code>invMixColumns</code> the 4 bytes are replaced by the 4 original ones.</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/7/76/AES-MixColumns.svg" alt="mixcols"></p>
<p>Speaking about the operation itself, it involves multiplication and addition in the Galois field. That sounded arcane to me, until I realised that I can get the results of multiplication via a lookup table and addition is just bit-wise XOR.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// a0-3 represent the bytes of a column from top to bottom</span>
<span class="token comment">// r0-3 are the transformed bytes</span>

<span class="token keyword">func</span> <span class="token function">calcMixCols</span><span class="token punctuation">(</span>a0<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3 <span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r0<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r3 <span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// r0 = 2*a0 + 3*a1 + a2   + a3</span>
	<span class="token comment">// r1 = a0   + 2*a1 + 3*a2 + a3</span>
	<span class="token comment">// r2 = a0   + a1   + 2*a2 + 3*a3</span>
	<span class="token comment">// r3 = 3*a0 + a1   + a2   + 2*a3</span>
  r0 <span class="token operator">=</span> gMulBy2<span class="token punctuation">[</span>a0<span class="token punctuation">]</span> <span class="token operator">^</span> gMulBy3<span class="token punctuation">[</span>a1<span class="token punctuation">]</span> <span class="token operator">^</span>  a2  <span class="token operator">^</span>  a3
  r1 <span class="token operator">=</span> a0          <span class="token operator">^</span> gMulBy2<span class="token punctuation">[</span>a1<span class="token punctuation">]</span> <span class="token operator">^</span> gMulBy3<span class="token punctuation">[</span>a2<span class="token punctuation">]</span> <span class="token operator">^</span> a3
  r2 <span class="token operator">=</span> a0  <span class="token operator">^</span>  a1   <span class="token operator">^</span> gMulBy2<span class="token punctuation">[</span>a2<span class="token punctuation">]</span> <span class="token operator">^</span> gMulBy3<span class="token punctuation">[</span>a3<span class="token punctuation">]</span>
  r3 <span class="token operator">=</span> gMulBy3<span class="token punctuation">[</span>a0<span class="token punctuation">]</span> <span class="token operator">^</span>  a1  <span class="token operator">^</span>  a2  <span class="token operator">^</span> gMulBy2<span class="token punctuation">[</span>a3<span class="token punctuation">]</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">calcInvMixCols</span><span class="token punctuation">(</span>a0<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> a2<span class="token punctuation">,</span> a3 <span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r0<span class="token punctuation">,</span> r1<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> r3 <span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// r0 = 14*a0 + 11*a1 + 13*a2 +  9*a3</span>
	<span class="token comment">// r1 =  9*a0 + 14*a1 + 11*a2 + 13*a3</span>
	<span class="token comment">// r2 = 13*a0 +  9*a1 + 14*a2 + 11*a3</span>
	<span class="token comment">// r3 = 11*a0 + 13*a1 +  9*a2 + 14*a3</span>
  r0 <span class="token operator">=</span> gMulBy14<span class="token punctuation">[</span>a0<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy11<span class="token punctuation">[</span>a1<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy13<span class="token punctuation">[</span>a2<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy9<span class="token punctuation">[</span>a3<span class="token punctuation">]</span>  
  r1 <span class="token operator">=</span> gMulBy9<span class="token punctuation">[</span>a0<span class="token punctuation">]</span> <span class="token operator">^</span>gMulBy14<span class="token punctuation">[</span>a1<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy11<span class="token punctuation">[</span>a2<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy13<span class="token punctuation">[</span>a3<span class="token punctuation">]</span>
  r2 <span class="token operator">=</span> gMulBy13<span class="token punctuation">[</span>a0<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy9<span class="token punctuation">[</span>a1<span class="token punctuation">]</span> <span class="token operator">^</span>gMulBy14<span class="token punctuation">[</span>a2<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy11<span class="token punctuation">[</span>a3<span class="token punctuation">]</span>
  r3 <span class="token operator">=</span> gMulBy11<span class="token punctuation">[</span>a0<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy13<span class="token punctuation">[</span>a1<span class="token punctuation">]</span><span class="token operator">^</span>gMulBy9<span class="token punctuation">[</span>a2<span class="token punctuation">]</span> <span class="token operator">^</span>gMulBy14<span class="token punctuation">[</span>a3<span class="token punctuation">]</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Each of the <code>gMulBy</code> lookup tables are 256 bytes in size. (You can find them <a href="https://en.wikipedia.org/wiki/Rijndael_mix_columns#Galois_Multiplication_lookup_tables">here</a>)</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go">input <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">{</span>
    <span class="token number">0xdbf201c6</span><span class="token punctuation">,</span>
    <span class="token number">0x130a01c6</span><span class="token punctuation">,</span>
    <span class="token number">0x532201c6</span><span class="token punctuation">,</span>
    <span class="token number">0x455c01c6</span><span class="token punctuation">}</span>
expected <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">{</span>
    <span class="token number">0x8e9f01c6</span><span class="token punctuation">,</span>
    <span class="token number">0x4ddc01c6</span><span class="token punctuation">,</span>
    <span class="token number">0xa15801c6</span><span class="token punctuation">,</span>
    <span class="token number">0xbc9d01c6</span><span class="token punctuation">}</span>
</code></pre></div>
<p>For <code>invMixColumns</code>, the test vectors are simply reversed. As with the other steps, it's a good idea to check if your <code>mixColumns</code> and <code>invMixColumns</code> invert each other.</p>
<p>I'm not going to explain Galois field arithmetic here for 2 reasons: I'd prefer to keep this post short, and its not necessary to know exactly how it works while implementing AES. I do recommend reading <a href="https://www.amazon.com/Design-RijndaeL-Encryption-Information-Cryptography/dp/3540425802">this book</a> by the creators of AES if you're interested in that or other interesting topics like cryptanalysis of AES.</p>
<hr>
<h3>Step 4: addRoundKey</h3>
<p>The simplest of all the steps. A bit-wise XOR between the 16-byte state and the appropriate 16-bytes of the expanded key.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">addRoundKey</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> key <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&#x3C;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> key<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>As you probably know, XOR-ing any input with the same key twice returns the original input. That's why we use the same operation with the same key in both encryption and decryption.</p>
<hr>
<h3>Step 0: Key Expansion</h3>
<p>I mentioned previously that the expanded key is based on the 16-byte key and its 16*(rounds+1) bytes in length. Thus, a different 16-bytes is used for each call to <code>addRoundKey</code></p>
<hr>
<h3>Potential gotcha</h3>
<p>Be careful of how you fill the state matrix with your 16 bytes of input.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// wrong</span>
 <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">2</span>  <span class="token number">3</span>
 <span class="token number">4</span>  <span class="token number">5</span>  <span class="token number">6</span>  <span class="token number">7</span>
 <span class="token number">8</span>  <span class="token number">9</span> <span class="token number">10</span> <span class="token number">11</span>
<span class="token number">12</span> <span class="token number">13</span> <span class="token number">14</span> <span class="token number">15</span>

<span class="token comment">// correct</span>
 <span class="token number">0</span>  <span class="token number">4</span>  <span class="token number">8</span> <span class="token number">12</span>
 <span class="token number">1</span>  <span class="token number">5</span>  <span class="token number">9</span> <span class="token number">13</span>
 <span class="token number">2</span>  <span class="token number">6</span> <span class="token number">10</span> <span class="token number">14</span>
 <span class="token number">3</span>  <span class="token number">7</span> <span class="token number">11</span> <span class="token number">15</span>
</code></pre></div>
<hr>
<h3>Congrats!</h3>
<p>You just implemented AES. Try decrypting the file <a href="https://cryptopals.com/sets/1/challenges/7/">here</a> to see if you got it right :)</p>
<p>If you haven't yet managed it, you could check out the <a href="http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf">FIPS-197 Document</a> which elaborates on each step.</p>
<hr>
<h3>My implementation</h3>
<p>You can find my implementation here:</p>
<ul>
<li><a href="https://github.com/nindalf/crypto/blob/master/aes/aes.go">aes.go</a> - <code>encrypt()</code>, <code>decrypt()</code> and all helper functions.</li>
<li><a href="https://github.com/nindalf/crypto/blob/master/aes/aes_test.go">aes_test.go</a> - test vectors for each step.</li>
<li><a href="https://github.com/nindalf/crypto/blob/master/aes/const.go">const.go</a> - S-boxes and the Galois-field multiplication lookup tables.</li>
</ul>
<p>The caveats mentioned in the foot-shooting-prevention agreement apply to my code as well. The linked code is useful for learning about AES, but is not secure and should not be used to encrypt anything important.</p>
<hr>
<h3>Advanced implementation</h3>
<p>The creators of AES designed the algorithm in such a way that implementations could make a trade-off between speed and code size. There are 4 possible levels, increasing in size and speed:</p>
<ul>
<li>0kB - no lookup tables, all steps are calculated, including substitution.</li>
<li>256 bytes x 2 - s-box and inverse-s-box are stored as lookup tables.</li>
<li>4kB x 2 - the Galois field multiplication tables are stored. (Approach taken by my impl.)</li>
<li>24kB x2 - The entire round (<code>subBytes</code>, <code>shiftRows</code> and <code>mixColumns</code>) are replaced by a lookup table. The only operation left is <code>addRoundKey</code>.</li>
</ul>
<p>The last is the fastest possible software implementation. Such an implementation can be found in the Go standard library <a href="https://golang.org/src/crypto/aes/block.go">here</a>. If the CPU's cache is large enough to accommodate the entire table, it will be really fast.</p>
<p>Hardware implementations are even faster. Intel and AMD introduced CPU instructions called <a href="https://en.wikipedia.org/wiki/AES_instruction_set">AES-NI</a>. These instructions are</p>
<ul>
<li><code>AESENC</code> and <code>AESENCLAST</code> (for the first n-1 round and last round respectively)</li>
<li><code>AESDEC</code> and <code>AESDECLAST</code></li>
<li><code>AESKEYGENASSIST</code> (to generate the expanded key)</li>
</ul>
<p>These instructions can perform AES in 3.5 CPU cycles/byte, while the best software implementation would take 10-30 cycles/byte. <a href="https://www.cryptopp.com/benchmarks-p4.html">source</a></p>
<p>The Go Standard Library also has <a href="https://golang.org/src/crypto/aes/asm_amd64.s">an implementation</a> that uses these instructions.</p>
<hr>
<h3>Closing</h3>
<p>I hope you found this post useful. I had a lot of fun learning about AES and implementing it and I wanted to share it with as many people as possible.</p>
</div></article></main><div class="utils_backToHome__2ednK"><a href="/">‚Üê Home</a></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"implementing-aes","wordCount":1506,"timeToRead":8,"contentHtml":"\u003cp\u003eThe Advanced Encryption Standard is the most widely used encryption algorithm today. Its fast and secure but also easy to understand and implement.\u003c/p\u003e\n\u003cp\u003eIf you're interested in learning about AES, look at this comic - \u003ca href=\"http://www.moserware.com/2009/09/stick-figure-guide-to-advanced.html\"\u003eA Stick Figure Guide to the Advanced Encryption Standard\u003c/a\u003e. He splits his comic into 4 Acts:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ebrief history of crypto\u003c/li\u003e\n\u003cli\u003ecrypto basics\u003c/li\u003e\n\u003cli\u003eimplementation\u003c/li\u003e\n\u003cli\u003emath.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eHe did a great job with all 4 parts, but I thought elaborating on the implementation would be helpful. In this post, I will only assume you've read Acts 2 and 3 and signed the foot-shooting-prevention agreement.\u003c/p\u003e\n\u003ccenter\u003e![Agreement](https://i.imgur.com/bPZzTwsl.png)\u003c/center\u003e\n\u003chr\u003e\n\u003ch3\u003eAES Encryption\u003c/h3\u003e\n\u003cp\u003eThe implementation of AES involves doing a set of simple operations repeatedly. Each repetition is called a \"round\". Depending on the size of the key (128, 192 or 256 bit), the input (block of 16 bytes) goes through 10, 12 or 14 rounds. In applying the 2 Big Ideas - Diffusion and Confusion, AES makes sure that each bit in the 16 byte block depends on every bit in the same block from 2 rounds previously. That's quite the achievement, so lets speak about the operations in detail.\u003c/p\u003e\n\u003cp\u003eEach round consists of 4 steps\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eapplying a key - \u003ccode\u003eaddRoundKey()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003esubstituting bytes - \u003ccode\u003esubBytes()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eshifting rows - \u003ccode\u003eshiftRows()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003emixing columns - \u003ccode\u003emixColumns()\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eDecryption involves the inverse of these steps, in reverse order\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003einverse-mixing columns - \u003ccode\u003einvMixColumns()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003einverse-shifting rows - \u003ccode\u003einvShiftRows()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003einverse-substituting bytes - \u003ccode\u003einvSubBytes()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eapplying a key - \u003ccode\u003eaddRoundKey()\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eHave a look at the \u003ccode\u003eencrypt\u003c/code\u003e function below, implemented in Go (Go has a C-like syntax)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eencrypt\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e expkey \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rounds \u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tkeyi \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003eaddRoundKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e expkey\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ekeyi\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ekeyi\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\tkeyi \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e4\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e rounds\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003esubBytes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003eshiftRows\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003emixColumns\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token function\"\u003eaddRoundKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e expkey\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ekeyi\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ekeyi\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\tkeyi \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e4\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003esubBytes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003eshiftRows\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token function\"\u003eaddRoundKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e expkey\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ekeyi\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003ekeyi\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eNotes on the implementation:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe 16-byte block, called state is represented as a slice of 4 4-byte unsigned integers. The 4-byte unsigned int is also referred to as a \"word\".\u003c/li\u003e\n\u003cli\u003eThe expanded key is based on the original key. Its 16*(rounds+1) bytes in length.\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 1: subBytes and invSubBytes\u003c/h3\u003e\n\u003cp\u003eAll the 4 operations are invertible. If you took any random 16-byte state and applied any operation and its inverse, you'd get back the original state. This is how decryption is a simple mirror of the encryption process.\u003c/p\u003e\n\u003cp\u003eIn \u003ccode\u003esubBytes\u003c/code\u003e each of the 16 bytes is replaced by a byte from the S-box (a lookup table). The code would look like:\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003einput\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003einput\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// i = 0, 1, ..., 15\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFor \u003ccode\u003einvSubBytes\u003c/code\u003e, only the lookup table is changed. The code is \u003ccode\u003einput[i] = invsbox[input[i]]\u003c/code\u003e. The values for both lookup tables can be found on the \u003ca href=\"https://en.wikipedia.org/wiki/Rijndael_S-box\"\u003ewiki page\u003c/a\u003e. If this step appears really simple, its because it is. Nevertheless, I'd suggest writing a test to check if its working correctly.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003einput \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token number\"\u003e0x8e9ff1c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0x4ddce1c7\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xa158d1c8\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xbc9dc1c9\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nexpected \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token number\"\u003e0x19dba1b4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xe386f8c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0x326a3ee8\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0x655e78dd\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAnother useful test would be to apply \u003ccode\u003esubBytes\u003c/code\u003e and \u003ccode\u003einvSubBytes\u003c/code\u003e on 16 random bytes and check if you get back the original.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 2: shiftRows and invShiftRows\u003c/h3\u003e\n\u003cp\u003eIn \u003ccode\u003eshiftRows\u003c/code\u003e, the rows are shifted left. The top row is left untouched, the second row by 1 byte, the third row by 2 bytes, the fourth row by 3 bytes. As depicted below\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://upload.wikimedia.org/wikipedia/commons/6/66/AES-ShiftRows.svg\" alt=\"shiftrows\"\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eshiftRows\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token comment\"\u003e// rotate word left by specified number of bytes\u003c/span\u003e\n\t\tstate\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erotWordLeft\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTo test if \u003ccode\u003eshiftRows\u003c/code\u003e working correctly, use this input\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003einput \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0x8e9f01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0x4ddc01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0xa15801c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0xbc9d01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nexpected \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0x8e9f01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0xdc01c64d\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0x01c6a158\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\t\t\u003cspan class=\"token number\"\u003e0xc6bc9d01\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e\u003ccode\u003einvShiftRows\u003c/code\u003e is the inverse operation. The top row is left untouched and the next 3 rows are shifted right by 1, 2, 3 bytes. Again, I'd recommend writing a test to ensure that applying both \u003ccode\u003eshiftRows\u003c/code\u003e and \u003ccode\u003einvShiftRows\u003c/code\u003e to random bytes returns the original.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 3: mixColumns and invMixColumns\u003c/h3\u003e\n\u003cp\u003eThis step is slightly complicated, compared to the other 3. The state is operated on column-wise. Each byte of the column is replaced based on an operation. As you'd expect, in \u003ccode\u003einvMixColumns\u003c/code\u003e the 4 bytes are replaced by the 4 original ones.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://upload.wikimedia.org/wikipedia/commons/7/76/AES-MixColumns.svg\" alt=\"mixcols\"\u003e\u003c/p\u003e\n\u003cp\u003eSpeaking about the operation itself, it involves multiplication and addition in the Galois field. That sounded arcane to me, until I realised that I can get the results of multiplication via a lookup table and addition is just bit-wise XOR.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// a0-3 represent the bytes of a column from top to bottom\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// r0-3 are the transformed bytes\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003ecalcMixCols\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a3 \u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er0\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r3 \u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r0 = 2*a0 + 3*a1 + a2   + a3\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r1 = a0   + 2*a1 + 3*a2 + a3\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r2 = a0   + a1   + 2*a2 + 3*a3\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r3 = 3*a0 + a1   + a2   + 2*a3\u003c/span\u003e\n  r0 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e gMulBy2\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e gMulBy3\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e  a2  \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e  a3\n  r1 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e a0          \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e gMulBy2\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e gMulBy3\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea2\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e a3\n  r2 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e a0  \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e  a1   \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e gMulBy2\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea2\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e gMulBy3\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea3\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  r3 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e gMulBy3\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e  a1  \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e  a2  \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e gMulBy2\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea3\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003ecalcInvMixCols\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e a3 \u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003er0\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r2\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r3 \u003cspan class=\"token builtin\"\u003ebyte\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r0 = 14*a0 + 11*a1 + 13*a2 +  9*a3\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r1 =  9*a0 + 14*a1 + 11*a2 + 13*a3\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r2 = 13*a0 +  9*a1 + 14*a2 + 11*a3\u003c/span\u003e\n\t\u003cspan class=\"token comment\"\u003e// r3 = 11*a0 + 13*a1 +  9*a2 + 14*a3\u003c/span\u003e\n  r0 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e gMulBy14\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy11\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy13\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea2\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy9\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea3\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e  \n  r1 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e gMulBy9\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy14\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy11\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea2\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy13\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea3\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  r2 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e gMulBy13\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy9\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy14\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea2\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy11\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea3\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  r3 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e gMulBy11\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea0\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy13\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy9\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea2\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003egMulBy14\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ea3\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eEach of the \u003ccode\u003egMulBy\u003c/code\u003e lookup tables are 256 bytes in size. (You can find them \u003ca href=\"https://en.wikipedia.org/wiki/Rijndael_mix_columns#Galois_Multiplication_lookup_tables\"\u003ehere\u003c/a\u003e)\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003einput \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0xdbf201c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0x130a01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0x532201c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0x455c01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nexpected \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0x8e9f01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0x4ddc01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0xa15801c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e0xbc9d01c6\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eFor \u003ccode\u003einvMixColumns\u003c/code\u003e, the test vectors are simply reversed. As with the other steps, it's a good idea to check if your \u003ccode\u003emixColumns\u003c/code\u003e and \u003ccode\u003einvMixColumns\u003c/code\u003e invert each other.\u003c/p\u003e\n\u003cp\u003eI'm not going to explain Galois field arithmetic here for 2 reasons: I'd prefer to keep this post short, and its not necessary to know exactly how it works while implementing AES. I do recommend reading \u003ca href=\"http://www.amazon.com/Design-RijndaeL-Encryption-Information-Cryptography/dp/3540425802\"\u003ethis book\u003c/a\u003e by the creators of AES if you're interested in that or other interesting topics like cryptanalysis of AES.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 4: addRoundKey\u003c/h3\u003e\n\u003cp\u003eThe simplest of all the steps. A bit-wise XOR between the 16-byte state and the appropriate 16-bytes of the expanded key.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003eaddRoundKey\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003estate\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e key \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003euint32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tstate\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e state\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you probably know, XOR-ing any input with the same key twice returns the original input. That's why we use the same operation with the same key in both encryption and decryption.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eStep 0: Key Expansion\u003c/h3\u003e\n\u003cp\u003eI mentioned previously that the expanded key is based on the 16-byte key and its 16*(rounds+1) bytes in length. Thus, a different 16-bytes is used for each  call to \u003ccode\u003eaddRoundKey\u003c/code\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003ePotential gotcha\u003c/h3\u003e\n\u003cp\u003eBe careful of how you fill the state matrix with your 16 bytes of input.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// wrong\u003c/span\u003e\n \u003cspan class=\"token number\"\u003e0\u003c/span\u003e  \u003cspan class=\"token number\"\u003e1\u003c/span\u003e  \u003cspan class=\"token number\"\u003e2\u003c/span\u003e  \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\n \u003cspan class=\"token number\"\u003e4\u003c/span\u003e  \u003cspan class=\"token number\"\u003e5\u003c/span\u003e  \u003cspan class=\"token number\"\u003e6\u003c/span\u003e  \u003cspan class=\"token number\"\u003e7\u003c/span\u003e\n \u003cspan class=\"token number\"\u003e8\u003c/span\u003e  \u003cspan class=\"token number\"\u003e9\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e \u003cspan class=\"token number\"\u003e11\u003c/span\u003e\n\u003cspan class=\"token number\"\u003e12\u003c/span\u003e \u003cspan class=\"token number\"\u003e13\u003c/span\u003e \u003cspan class=\"token number\"\u003e14\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// correct\u003c/span\u003e\n \u003cspan class=\"token number\"\u003e0\u003c/span\u003e  \u003cspan class=\"token number\"\u003e4\u003c/span\u003e  \u003cspan class=\"token number\"\u003e8\u003c/span\u003e \u003cspan class=\"token number\"\u003e12\u003c/span\u003e\n \u003cspan class=\"token number\"\u003e1\u003c/span\u003e  \u003cspan class=\"token number\"\u003e5\u003c/span\u003e  \u003cspan class=\"token number\"\u003e9\u003c/span\u003e \u003cspan class=\"token number\"\u003e13\u003c/span\u003e\n \u003cspan class=\"token number\"\u003e2\u003c/span\u003e  \u003cspan class=\"token number\"\u003e6\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e \u003cspan class=\"token number\"\u003e14\u003c/span\u003e\n \u003cspan class=\"token number\"\u003e3\u003c/span\u003e  \u003cspan class=\"token number\"\u003e7\u003c/span\u003e \u003cspan class=\"token number\"\u003e11\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003chr\u003e\n\u003ch3\u003eCongrats!\u003c/h3\u003e\n\u003cp\u003eYou just implemented AES. Try decrypting the file \u003ca href=\"http://cryptopals.com/sets/1/challenges/7/\"\u003ehere\u003c/a\u003e to see if you got it right :)\u003c/p\u003e\n\u003cp\u003eIf you haven't yet managed it, you could check out the \u003ca href=\"http://csrc.nist.gov/publications/fips/fips197/fips-197.pdf\"\u003eFIPS-197 Document\u003c/a\u003e which elaborates on each step.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eMy implementation\u003c/h3\u003e\n\u003cp\u003eYou can find my implementation here:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/nindalf/crypto/blob/master/aes/aes.go\"\u003eaes.go\u003c/a\u003e - \u003ccode\u003eencrypt()\u003c/code\u003e, \u003ccode\u003edecrypt()\u003c/code\u003e and all helper functions.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/nindalf/crypto/blob/master/aes/aes_test.go\"\u003eaes_test.go\u003c/a\u003e - test vectors for each step.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/nindalf/crypto/blob/master/aes/const.go\"\u003econst.go\u003c/a\u003e - S-boxes and the Galois-field multiplication lookup tables.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe caveats mentioned in the foot-shooting-prevention agreement apply to my code as well. The linked code is useful for learning about AES, but is not secure and should not be used to encrypt anything important.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eAdvanced implementation\u003c/h3\u003e\n\u003cp\u003eThe creators of AES designed the algorithm in such a way that implementations could make a trade-off between speed and code size. There are 4 possible levels, increasing in size and speed:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e0kB - no lookup tables, all steps are calculated, including substitution.\u003c/li\u003e\n\u003cli\u003e256 bytes x 2 - s-box and inverse-s-box are stored as lookup tables.\u003c/li\u003e\n\u003cli\u003e4kB x 2  - the Galois field multiplication tables are stored. (Approach taken by my impl.)\u003c/li\u003e\n\u003cli\u003e24kB x2 - The entire round (\u003ccode\u003esubBytes\u003c/code\u003e, \u003ccode\u003eshiftRows\u003c/code\u003e and \u003ccode\u003emixColumns\u003c/code\u003e) are replaced by a lookup table. The only operation left is \u003ccode\u003eaddRoundKey\u003c/code\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe last is the fastest possible software implementation. Such an implementation can be found in the Go standard library \u003ca href=\"http://golang.org/src/crypto/aes/block.go\"\u003ehere\u003c/a\u003e. If the CPU's cache is large enough to accommodate the entire table, it will be really fast.\u003c/p\u003e\n\u003cp\u003eHardware implementations are even faster. Intel and AMD introduced CPU instructions called \u003ca href=\"https://en.wikipedia.org/wiki/AES_instruction_set\"\u003eAES-NI\u003c/a\u003e. These instructions are\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eAESENC\u003c/code\u003e and \u003ccode\u003eAESENCLAST\u003c/code\u003e (for the first n-1 round and last round respectively)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eAESDEC\u003c/code\u003e and \u003ccode\u003eAESDECLAST\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eAESKEYGENASSIST\u003c/code\u003e (to generate the expanded key)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThese instructions can perform AES in 3.5 CPU cycles/byte, while the best software implementation would take 10-30 cycles/byte. \u003ca href=\"http://www.cryptopp.com/benchmarks-p4.html\"\u003esource\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe Go Standard Library also has \u003ca href=\"http://golang.org/src/crypto/aes/asm_amd64.s\"\u003ean implementation\u003c/a\u003e that uses these instructions.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3\u003eClosing\u003c/h3\u003e\n\u003cp\u003eI hope you found this post useful. I had a lot of fun learning about AES and implementing it and I wanted to share it with as many people as possible.\u003c/p\u003e\n","preview":"The Advanced Encryption Standard is the most widely used encryption algorithm today. Its fast and secure but also easy to understand and implement.","title":"Implementing AES","date":"2015-07-30","aliases":["implementing-aes"],"tags":["tech"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"implementing-aes"},"buildId":"Jf-wop3a-jR8I9PxYMsgo","isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-8683bd742a84c1edd48c.js"></script><script src="/_next/static/chunks/webpack-18c200bfa4628d9da94c.js" async=""></script><script src="/_next/static/chunks/framework-5e33f488d9410ce9ba9d.js" async=""></script><script src="/_next/static/chunks/597-e9cbf8ad4e8557f256b3.js" async=""></script><script src="/_next/static/chunks/778-c9e86f308cd9cb372f22.js" async=""></script><script src="/_next/static/chunks/main-9ca82ec4d4aca520c43d.js" async=""></script><script src="/_next/static/chunks/pages/_app-33eebf5131cfd5d17810.js" async=""></script><script src="/_next/static/chunks/941-89b1c2f25315e4a44edb.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-4aeed08a217f27d1079a.js" async=""></script><script src="/_next/static/Jf-wop3a-jR8I9PxYMsgo/_buildManifest.js" async=""></script><script src="/_next/static/Jf-wop3a-jR8I9PxYMsgo/_ssgManifest.js" async=""></script><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "e957a0fd477941f5a9aa5fc4be0670df"}'></script></body></html>